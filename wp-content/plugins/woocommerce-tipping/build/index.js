(()=>{"use strict";const e=window.wp.i18n,t=window.wp.element,a=window.window.wc.components,r=window.ReactJSXRuntime;class s extends t.Component{constructor(e){super(e),this.handleSort=this.handleSort.bind(this);const t="date",a="desc",r=this.sort(this.props.tipOrders,t,a);this.state={orderData:r,sortColumn:t,sortOrder:a}}sort(e,t,a){const r="asc"===a?1:-1;return e.sort(((e,a)=>e[t]>a[t]?r:e[t]<a[t]?-1*r:0))}handleSort(e){let{orderData:t,sortColumn:a,sortOrder:r}=this.state;a===e?(t.reverse(),r=this.changeSortOrder(r)):(a=e,t=this.sort(t,a,r)),this.setState({orderData:t,sortColumn:a,sortOrder:r})}changeSortOrder(e){return"asc"===e?"desc":"asc"}setHeaderSortOptions(e){return e.key===this.state.sortColumn?(e.defaultSort=!0,e.defaultOrder=this.state.sortOrder):(e.defaultSort&&delete e.defaultSort,e.defaultOrder&&delete e.defaultOrder),e}render(){const t=this.state.orderData,s=this.props.totals,o=this.props.currency,i={headers:this.props.headers,rows:t.map((e=>[{display:e.date_created,value:e.date_created},{display:e.order_id,value:e.order_id},{display:e.customer,value:e.customer},{display:o.render(e.order_total),value:e.order_total},{display:o.render(e.tip_amount),value:e.tip_amount}])),summary:[{key:"sales",label:(0,e.__)("Total Tips","wpslash-tipping"),value:o.render(s.total_tips)},{key:"orders",label:(0,e.__)("Orders with a Tip","wpslash-tipping"),value:s.total_orders},{key:"countries",label:(0,e.__)("Average Tip Amount","wpslash-tipping"),value:o.render(s.average_tip)}]};return(0,r.jsx)(a.TableCard,{title:(0,e.__)("Tips","wpslash-tipping"),rows:i.rows,headers:this.props.headers.map((e=>this.setHeaderSortOptions(e))),rowsPerPage:this.props.rowsPerPage,totalRows:this.props.totals.total_orders,summary:i.summary,onSort:this.handleSort,onPageChange:this.props.onPageChange,onPerPageChange:this.props.onPageChange,query:{paged:this.props.query.paged,per_page:this.props.query.per_page}})}}const{Component:o,Fragment:i}=wp.element,{ChartPlaceholder:n,ReportFilters:p,SummaryList:l,SummaryListPlaceholder:h,SummaryNumber:d,TablePlaceholder:c}=wc.components,{__}=wp.i18n,{appendTimestamp:g,getCurrentDates:u,getDateParamsFromQuery:m,isoDateFormat:y}=wc.date,_=wc.currency.default,w=wc.wcSettings.CURRENCY,C=wp.apiFetch;class P extends o{constructor(e){super(e),this.handleDateChange=this.handleDateChange.bind(this),this.handlePageChange=this.handlePageChange.bind(this),this.onPageChange=this.onPageChange.bind(this),this.onPerPageChange=this.onPerPageChange.bind(this),this.onQueryChange=this.onQueryChange.bind(this);const t=this.createDateQuery(this.props.query),a=new _(w);this.state={dateQuery:t,currency:a,page:1,per_page:10,data:{loading:!0}},this.fetchData(this.state.dateQuery)}fetchData(e,t=this.state.page){this.state.data.loading||this.setState({data:{loading:!0}});const a="/wc-analytics/tips?get",r="/wc-analytics/reports/customers?_fields=id,country",s=this.getQueryParameters(e,t),o=a+s;console.log(o);const i=r+s;Promise.all([C({path:o}),C({path:i})]).then((([e,t])=>{console.log(e);const a=this.prepareData(e,t);this.setState({data:a})})).catch((e=>console.log(e)))}getQueryParameters(e,t=this.state.page){return`&after=${encodeURIComponent(g(e.primaryDate.after,"start"))}&before=${encodeURIComponent(g(e.primaryDate.before,"end"))}&interval=day&order=asc&per_page=${this.state.per_page}&page=${t}&_locale=user`}prepareData(e,t){console.log(e);let a={};return e.pages>0?(a.totals={total_tips:e.tips_total,orders:e.total,average_tip:e.tips_total/e.total,total_orders:e.total,pages:e.pages},a.orders=e.orders):a={orders:[],totals:{total_sales:0,orders:0,countries:0}},a.loading=!1,console.log(a),a}getTotalNumber(e,t){const a=e.reduce(((e,a)=>e+a[t]),0);return Math.round(100*a)/100}handleDateChange(e){const t=this.createDateQuery(e);this.setState({dateQuery:t}),this.fetchData(t)}handlePageChange(e){this.setState({per_page:e}),this.fetchData(newDateQuery)}onPageChange(e){console.log(e),this.setState({page:e},this.fetchData(this.state.dateQuery,e))}onQueryChange(e){console.log(e),this.setState({page:2},this.fetchData(this.state.dateQuery))}onPerPageChange(e){console.log(e),this.setState({per_page:e}),this.fetchData(this.state.dateQuery)}render(){const e=(0,r.jsx)(p,{dateQuery:this.state.dateQuery,query:this.props.query,path:this.props.path,currency:this.state.currency,onDateSelect:this.handleDateChange,isoDateFormat:y}),t=[{key:"date",label:__("Date","woocommerce"),isLeftAligned:!0,isSortable:!0,required:!0},{key:"id",label:__("Order #","woocommerce"),isSortable:!0,isNumeric:!0},{key:"customer",label:__("Customer","woocommerce"),isSortable:!0,isNumeric:!0},{key:"order_total",label:__("Order Total","wpslash-tipping"),isSortable:!0,isNumeric:!0},{key:"tip_amount",label:__("Tip Amount","wpslash-tipping"),isSortable:!0,isNumeric:!0}],{data:a,currency:o}=this.state;return this.state.data.loading?(0,r.jsx)("p",{children:"Waiting..."}):(0,r.jsxs)(i,{children:[e,(0,r.jsx)(l,{children:()=>[(0,r.jsx)(d,{value:o.render(a.totals.total_tips),label:__("Total Tips","wpslash-tipping")},"total_tips"),(0,r.jsx)(d,{value:a.totals.orders,label:__("Orders with a Tip","wpslash-tipping")},"orders_with_tip"),(0,r.jsx)(d,{value:o.render(a.totals.average_tip),label:__("Average Tip Amount","wpslash-tipping")},"average_tip")]}),(0,r.jsx)(s,{tipOrders:a.orders,totals:a.totals,currency:o,onPageChange:this.onPageChange,onPerPageChange:this.onPerPageChange,rowsPerPage:this.state.per_page,query:{paged:this.state.page,per_page:this.state.per_page},headers:t})]})}createDateQuery(e){const{period:t,compare:a,before:r,after:s}=m(e),{primary:o,secondary:i}=u(e);return{period:t,compare:a,before:r,after:s,primaryDate:o,secondaryDate:i}}}const{addFilter:D}=wp.hooks,{__:S}=wp.i18n;D("woocommerce_admin_reports_list","wpslash-tipping-analytics",(e=>[...e,{report:"tips",title:S("Tips","wpslash-tipping"),component:P}]))})();