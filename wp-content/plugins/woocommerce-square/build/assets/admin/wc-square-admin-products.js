jQuery(document).ready(e=>{const t=window.typenow||"",s=window.pagenow||"",__=wp.i18n.__;if("product"===t&&wc_square_admin_products.is_product_sync_enabled){if("product_page_product_importer"===s){const i='<div class="error"><p>'+__("Product syncing with square has been enabled. If you are trying to update product inventory, you should do it in Square. Your existing inventory data in WooCommerce will be overwritten with data from Square products.","woocommerce-square")+"</p></div>";e(".wc-progress-steps").after(i)}if("edit-product"===s){if(wc_square_admin_products.is_inventory_sync_enabled){const o=new MutationObserver(t=>{t.forEach(t=>{t.addedNodes.forEach(t=>{if(1===t.nodeType&&"bulk-edit"===t.id){const s=e(t),a=s.find("select.stock_status").closest("label");if(a.length&&!s.find(".wc-square-bulk-edit-notice").length){const e='<div class="wc-square-bulk-edit-notice notice notice-warning inline" style="margin: 10px 0; padding: 8px 12px;"><p style="margin: 0;">'+__("Inventory updates made here will not apply to Square-synced products. Stock values for these products are managed in Square and will be overwritten during the next sync.","woocommerce-square")+"</p></div>";a.before(e)}}})})}),c=document.querySelector("#the-list");c&&c.parentNode&&o.observe(c.parentNode,{childList:!0,subtree:!0})}e("#the-list").on("click",".editinline",t=>{const s=e(t.target).closest("tr").find("th.check-column input").val(),a={action:"wc_square_get_quick_edit_product_details",security:wc_square_admin_products.get_quick_edit_product_details_nonce,product_id:s};e.post(wc_square_admin_products.ajax_url,a,t=>{const a=e("tr#edit-"+s),r=a.find("select.square-synced"),i=a.find(".wc-square-sync-with-square-errors");if(!t.success&&t.data&&"missing_variation_sku"===t.data)return r.prop("checked",!1),r.prop("disabled",!0),void i.find(".missing_variation_sku").show();const o=a.find("input[name=_sku]"),c=a.find("select[name=_stock_status]"),n=a.find("input[name=_stock]"),d=a.find(".manage_stock_field .manage_stock"),_=a.find("input[name=_manage_stock]"),u='<span class="description"><a href="'+wc_square_admin_products.settings_url+'">'+wc_square_admin_products.i18n.synced_with_square+"</a></span>",l=t.data.edit_url,p=t.data.i18n,h=t.data.is_variable;r.val(t.data.is_synced_with_square),o.on("change keyup keypress",t=>{if(""!==e(t.target).val()||h)return r.prop("disabled",!1),r.trigger("change"),i.find(".missing_sku").hide();r.val("no").trigger("change"),r.prop("disabled",!0),i.find(".missing_sku").show()}).trigger("change"),r.on("change",t=>{wc_square_admin_products.is_inventory_sync_enabled&&("no"===e(t.target).val()?(_.off(),_.add(n).css({opacity:1}),d.find(".description").remove(),h?_.is(":checked")?(e(".stock_qty_field").show(),e(".backorder_field").show()):e(".stock_status_field").show():(n.prop("readonly",!1),c.off("mousedown keydown change"),c.css({opacity:1}))):(_.on("click",()=>!1),_.add(n).css({opacity:"0.5"}),d.append(u),wc_square_admin_products.is_woocommerce_sor&&l&&p&&d.append('<p class="description"><a href="'+l+'">'+p+"</a></p>"),h?(e(".stock_status_field").hide(),e(".stock_qty_field").hide(),e(".backorder_field").hide()):(n.prop("readonly",!0),c.on("mousedown keydown change",()=>!1),c.css({opacity:.5}))))}).trigger("change")})})}if("product"===s){const n="#_"+wc_square_admin_products.synced_with_square_taxonomy,d=()=>wc_square_admin_products.variable_product_types.includes(e("#product-type").val()),_=()=>""!==e("#_sku").val().trim(),u=t=>!!t.length&&t.filter(t=>""!==e(t).val().trim()).length===t.length,l=t=>{const s=t.map(t=>e(t).val());return s.every(e=>s.indexOf(e)===s.lastIndexOf(e))},p=()=>{const t=e('.woocommerce_attribute_data input[name^="attribute_variation"]:checked');return d()&&t&&t.length>1},h=t=>{e(".wc-square-sync-with-square-error."+t).show(),e(n).prop("disabled",!0),e(n).prop("checked",!1)},m=(t,s=!0)=>{e(".wc-square-sync-with-square-error."+t).hide(),s&&e(n).prop("disabled",!1)},f=t=>{if(d()){e("#_sku").off("change keypress keyup"),m("missing_sku",!p());const s=e('input[id^="variable_sku"]');s.on("change keypress keyup",()=>{u(e.makeArray(s))&&l(e.makeArray(s))?m("missing_variation_sku",!p()):h("missing_variation_sku"),e(t).triggerHandler("change")}).triggerHandler("change")}else e('input[id^="variable_sku"]').off("change keypress keyup"),m("missing_variation_sku",!p()),e("#_sku").on("change keypress keyup",s=>{""===e(s.target).val().trim()?h("missing_sku"):m("missing_sku",!p()),e(t).trigger("change")}).trigger("change")},w=t=>{e("#variable_product_options").on("reload",()=>{_()&&e(t).prop("disabled",!1),e(t).trigger("change")}).trigger("reload")},y=()=>{f(n),e(n).trigger("change"),d()&&!e('input[id^="variable_sku"]').length&&h("missing_variation_sku")},g=t=>{const s=e(".wc-square-sync-with-square");wc_square_admin_products.supported_products_for_sync.includes(t)?s.show():s.hide()},v=e("#product-type").val();g(v),w(n);const k=e(".stock_fields"),q=k.find("#_stock"),b=e(".stock_status_field"),x=b.find('input[name="_stock_status"]'),S=e("._manage_stock_field"),D=S.find("#_manage_stock"),j=S.find(".description"),I=j.text(),E=e("#_manage_stock").is(":checked");function a(){const t=e("#product-type").val(),s=e("#_square_gift_card").prop("checked");let a=[e(".wc-square-sync-with-square"),e(".inventory_sold_individually"),e('label[for="_virtual"]'),e('label[for="_downloadable"]'),e("._tax_status_field").closest(".options_group")];"variable"===t&&(a=[...a,e(".variable_is_virtual").closest(".tips"),e(".variable_is_downloadable").closest(".tips")]),s?(e("#_virtual").prop("checked")||e("#_virtual").trigger("click").prop("checked",!0),e(".variable_is_virtual").each((t,s)=>{e(s).prop("checked")||e(s).trigger("click").prop("checked",!0)}),a.forEach(e=>e.hide())):(a.forEach(e=>e.show()),"variable"===t&&(e('label[for="_virtual"]').hide(),e('label[for="_downloadable"]').hide()))}e(n).on("change",t=>{if(!wc_square_admin_products.is_inventory_sync_enabled)return;const s=wc_square_admin_products.variable_product_types.includes(e("#product-type").val());let a;if(e(t.target).is(":checked")&&e("#_square_item_variation_id").length>0){a=!0;let t="";D.is(":checked")||s||(t=' (<a href="#" class="sync-stock-from-square" data-product-id="'+e("#post_ID").val()+'">'+wc_square_admin_products.i18n.sync_inventory+'</a>)<div class="sync-stock-spinner spinner" style="float:none;"></div>'),j.html('<a href="'+wc_square_admin_products.settings_url+'">'+wc_square_admin_products.i18n.synced_with_square+"</a>"+t),D.on("click",()=>!1),D.css({opacity:"0.5"}),x.css({opacity:.5}),x.on("mousedown keydown click",()=>!1),q.prop("readonly",!0),wc_square_admin_products.is_woocommerce_sor&&!s?(0===e("p._stock_field span.description").length&&q.after('<span class="description" style="display:block;clear:both;"><a href="#" id="fetch-stock-with-square">'+wc_square_admin_products.i18n.fetch_stock_with_square+'</a><div class="spinner" style="float:none;"></div></span>'),e("#fetch-stock-with-square").on("click",t=>{t.preventDefault();const s=e("p._stock_field span.description .spinner"),a={action:"wc_square_fetch_product_stock_with_square",security:wc_square_admin_products.fetch_product_stock_with_square_nonce,product_id:e("#post_ID").val()};s.css("visibility","visible"),e.post(wc_square_admin_products.ajax_url,a,t=>{if(t&&t.success){const s=t.data.quantity;t.data.manage_stock||(D.prop("checked",!1).trigger("change"),e("#_stock_status").val("instock"),j.html('<a href="'+wc_square_admin_products.settings_url+'">'+wc_square_admin_products.i18n.inventory_tracking_disabled+"</a>")),q.val(s),k.find("input[name=_original_stock]").val(s),q.prop("readonly",!1),e("p._stock_field span.description").remove()}else t.data&&(e(".inventory-fetch-error").remove(),s.after('<span class="inventory-fetch-error" style="display:inline-block;color:red;">'+t.data+"</span>")),s.css("visibility","hidden")})})):wc_square_admin_products.is_square_sor&&0===e("p._stock_field span.description").length&&q.after('<span class="description" style="display:block;clear:both;">'+wc_square_admin_products.i18n.managed_by_square+' (<a href="#" class="sync-stock-from-square" data-product-id="'+e("#post_ID").val()+'">'+wc_square_admin_products.i18n.sync_stock_from_square+'</a>)<div class="sync-stock-spinner spinner" style="float:none;"></div></span>')}else a=!1,e("p._stock_field span.description").remove(),e(".sync-stock-from-square").remove(),q.prop("readonly",!1),j.html(I),D.off("click"),D.css({opacity:1}),D.prop("checked",E),x.css({opacity:1}),x.off("mousedown keydown click"),s||(E?(k.show(),b.hide()):(b.show(),k.hide()));e(".woocommerce_variation").each((t,s)=>{const r=e(s).find("h3 input.variable_post_id").val(),i=e(s).find(".variable_manage_stock"),o=i.parent(),c=e(s).find(".wc_input_stock"),n=c.parent(),d=e(s).find(".variable_stock_status select");if(a){if(c.prop("readonly",!0),i.on("click",()=>!1),i.css({opacity:"0.5"}),d.css({opacity:.5}),d.on("mousedown keydown change",()=>!1),0===o.find(".description").length){let e="";i.is(":checked")||(e='<a href="#" class="sync-stock-from-square" data-product-id="'+r+'">'+wc_square_admin_products.i18n.sync_inventory+'</a><div class="sync-stock-spinner spinner" style="float:none;"></div>'),o.find(".sync-stock-from-square").length||i.after(`<span class="description">(${wc_square_admin_products.i18n.managed_by_square})${e?" - ":""}</span> ${e}`)}if(wc_square_admin_products.is_woocommerce_sor){const t="fetch-stock-with-square-"+r;0===n.find("span.description").length&&c.after('<span class="description" style="display:block;clear:both;"><a href="#" id="'+t+'">'+wc_square_admin_products.i18n.fetch_stock_with_square+'</a><div class="spinner" style="float:none;"></div></span>'),e("#"+t).on("click",t=>{t.preventDefault();const s=e(t.target).next(".spinner"),a={action:"wc_square_fetch_product_stock_with_square",security:wc_square_admin_products.fetch_product_stock_with_square_nonce,product_id:r};s.css("visibility","visible"),e.post(wc_square_admin_products.ajax_url,a,t=>{if(t&&t.success){const e=t.data.quantity;t.data.manage_stock||i.prop("checked",!1).trigger("change"),c.val(e),n.parent().find('input[name^="variable_original_stock"]').val(e),c.prop("readonly",!1),n.find(".description").remove()}else t.data&&(e(".inventory-fetch-error").remove(),s.after('<span class="inventory-fetch-error" style="display:inline-block;color:red;">'+t.data+"</span>")),s.css("visibility","hidden")})})}else wc_square_admin_products.is_square_sor&&0===n.find("span.description").length&&c.after('<span class="description" style="display:block;clear:both;"><a href="#" class="sync-stock-from-square" data-product-id="'+r+'">'+wc_square_admin_products.i18n.sync_stock_from_square+'</a><div class="sync-stock-spinner spinner" style="float:none;"></span>')}else c.prop("readonly",!1),i.off("click"),i.css({opacity:1}),i.next(".description").remove(),d.css({opacity:1}),d.off("mousedown keydown change")})}).trigger("change"),e("#product-type").on("change",function(t){g(e(t.target).val()),y()}),e("#woocommerce-product-data").on("click",".sync-stock-from-square",t=>{t.preventDefault();const s=e(t.target).data("product-id"),a=e(".sync-stock-spinner.spinner"),r={action:"wc_square_fetch_product_stock_with_square",security:wc_square_admin_products.fetch_product_stock_with_square_nonce,product_id:s};a.css("visibility","visible"),e.post(wc_square_admin_products.ajax_url,r,()=>{a.css("visibility","hidden"),window.location.reload()})}),a(),e("#product-type, #_square_gift_card").on("change",a),e("#woocommerce-product-data").on("click",".sync-stock-from-square",t=>{t.preventDefault();const s=e(t.target).data("product-id"),a=e(".sync-stock-spinner.spinner"),r={action:"wc_square_fetch_product_stock_with_square",security:wc_square_admin_products.fetch_product_stock_with_square_nonce,product_id:s};a.css("visibility","visible"),e.post(wc_square_admin_products.ajax_url,r,()=>{a.css("visibility","hidden"),window.location.reload()})});let A=null;function r(){let t=document.querySelector(".woocommerce_variations");!A&&t&&(A=new MutationObserver(()=>{e("#_square_gift_card").trigger("change")}),A&&A.observe(t,{attributes:!1,childList:!0,subtree:!1}))}r(),e("#woocommerce-product-data").on("woocommerce_variations_loaded woocommerce_variations_added woocommerce_variations_removed",()=>{r(),y()});const C=(t,s)=>{const a=e(t);a.addClass("wc-square-field-error-highlight");let r=e("#wc-square-validation-errors");r.length||(r=e('<div id="wc-square-validation-errors" class="wc-square-validation-errors"><h4>'+__("Square Sync Validation Errors","woocommerce-square")+"</h4><ul></ul></div>"),e("#woocommerce-product-data").prepend(r));const i=r.find("ul"),o="square-error-"+a.attr("id");e("#"+o).length?e("#"+o).text(s):i.append('<li id="'+o+'">'+s+"</li>")},O=e=>(e.attr("id")||e.attr("id","wc-square-field-"+Math.random().toString(36).substring(2,15)),e),M=t=>{t.removeClass("wc-square-field-error-highlight"),e("#square-error-"+t.attr("id")).remove(),e("#wc-square-validation-errors ul li").length||e("#wc-square-validation-errors").remove()},N=()=>{e(".wc-square-field-error-highlight").removeClass("wc-square-field-error-highlight"),e("#wc-square-validation-errors").remove()},$=(e,t,s,a)=>(s=O(s),e>t?(C(s,a),!1):(M(s),!0)),H=e=>{const t=e.val();return $(t.length,65,e,wc_square_admin_products.i18n.attribute_name_too_long+": "+t.substring(0,65)+"...")},L=()=>$(e("#product_attributes .woocommerce_attribute").length,6,e(".attribute_tab"),wc_square_admin_products.i18n.too_many_attributes),P=e=>{let t,s=e.val();return t=Array.isArray(s)?s.length:s.split("|").filter(e=>""!==e.trim()).length,$(t,250,e,wc_square_admin_products.i18n.too_many_attribute_values.replace("%d",t))},Q=()=>$(e("#woocommerce-product-data").find(".woocommerce_variation").length,250,e(".variations_tab"),wc_square_admin_products.i18n.too_many_variations);e("#product-type").on("change",()=>{"variable"===e("#product-type").val()?T():N()});const T=()=>{if(!d())return;const t=e("#_"+wc_square_admin_products.synced_with_square_taxonomy),s=e("#product_attributes"),a=e("#woocommerce-product-data"),r=()=>{N(),t.prop("checked")&&d()&&(L(),Q(),s.find("input.attribute_name").each(function(){H(e(this))}),s.find('[name*="attribute_values"]').each(function(){P(e(this))}))};s.on("change","input.attribute_name",function(){t.prop("checked")&&(H(e(this)),L())}).on("change",'[name*="attribute_values"]',function(){t.prop("checked")&&P(e(this))}).on("click",".product_attributes .delete",function(){t.prop("checked")&&L()}),a.on("click",".save-variation-changes, #variable_product_options button",Q),a.on("woocommerce_variations_loaded woocommerce_variations_added woocommerce_variations_removed",r),t.on("change",r),r()};e(document).ready(T)}}});